# =============================================================================
# Base Image and Build Arguments
#  - Locked to a specific version of the ROS image to ensure reproducibility
#  - Updates here: https://hub.docker.com/r/osrf/ros/tags?name=jazzy-desktop
# =============================================================================
FROM dustynv/ros:jazzy-desktop-r36.4.0-cu128-24.04@sha256:45236ccbdcd74176d6d4c12ae02c2dc8228a1a944d4161b67e8f33d91ed52c8c

ARG gid
ARG uid
ARG username

# Update ROS key
RUN sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg

# =============================================================================
# System Package Installation
# =============================================================================
RUN apt-get update && apt-get install -y \
  build-essential \
  git \
  python3-pip \
  python3-dev \
  python3-venv \
  python3-setuptools \
  python3-wheel \
  python3-numpy \
  python3-scipy \
  python3-matplotlib \
  python3-pandas \
  python3-tqdm \
  python3-pytest \
  python3-seaborn \
  python3-pygame \
  git \
  wget \
  vim \
  curl \
  psmisc \
  sudo

# =============================================================================
# Realsense
# =============================================================================
RUN apt-get update && apt-get install -y \
  kmod
COPY scripts/install_realsense_library.sh /tmp/install_realsense_library.sh
COPY external/librealsense /tmp/librealsense
RUN /tmp/install_realsense_library.sh && rm /tmp/install_realsense_library.sh

COPY scripts/ros2_deps.sh /tmp/ros2_deps.sh
RUN /tmp/ros2_deps.sh && rm /tmp/ros2_deps.sh

# =============================================================================
# UT AUTOmata dependencies
# =============================================================================
RUN apt-get update && apt-get install -y \
  libgoogle-glog-dev \
  libgflags-dev \
  liblua5.1-0-dev \
  libqt5websockets5-dev \
  libqt5opengl5-dev

# So we can detect if we are in a container
ENV CONTAINER_NAME=roboracer_ws

# =============================================================================
# User Creation and Configuration
# =============================================================================
ENV UID=$uid
ENV GID=$gid
ENV USERNAME=$username

# Create user and group, then configure sudo
RUN set -e && \
    # Create group if it doesn't exist
    getent group ${GID} || groupadd -g ${GID} ${USERNAME} && \
    # Handle user creation/modification
    if id ${UID} >/dev/null 2>&1; then \
        # User with this UID exists, modify it
        existing_user=$(id -nu ${UID}) && \
        usermod -l ${USERNAME} -d /home/${USERNAME} -m $existing_user 2>/dev/null || true && \
        usermod -g ${GID} ${USERNAME} 2>/dev/null || true; \
    else \
        # Create new user
        useradd -u ${UID} -g ${GID} -m -s /bin/bash ${USERNAME}; \
    fi && \
    # Ensure home directory exists and has correct ownership
    mkdir -p /home/${USERNAME} && \
    chown -R ${UID}:${GID} /home/${USERNAME} && \
    # Add to sudo group and configure passwordless sudo
    usermod -aG sudo ${USERNAME} && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/${USERNAME} && \
    chmod 0440 /etc/sudoers.d/${USERNAME} && \
    visudo -c

RUN echo "export PATH=/home/${USERNAME}/.local/bin/:${PATH}" >> /home/${USERNAME}/.bash_profile && \
    echo "export LC_ALL=C.UTF-8" >> /home/${USERNAME}/.bash_profile && \
    echo "export LANG=C.UTF-8" >> /home/${USERNAME}/.bash_profile && \
    echo "alias killros2='killall -9 ros2 _ros2_daemon rviz2 gzserver robot_state_publisher gzclient controller_server lifecycle_manager'" >> /home/${USERNAME}/.bash_profile && \
    echo "source \"/opt/ros/$ROS_DISTRO/setup.bash\" --" >> /home/${USERNAME}/.bash_profile && \
    echo "source \"/home/${USERNAME}/roboracer_ws/install/setup.bash\" --" >> /home/${USERNAME}/.bash_profile && \
    echo "export AMENT_PREFIX_PATH=/home/${USERNAME}/roboracer_ws/src/amrl_msgs/install:\$AMENT_PREFIX_PATH" >> /home/${USERNAME}/.bash_profile && \
    echo "export AMENT_PREFIX_PATH=/home/${USERNAME}/roboracer_ws/src/amrl_maps/install:\$AMENT_PREFIX_PATH" >> /home/${USERNAME}/.bash_profile && \
    echo "export ROS_VERSION=2" >> /home/${USERNAME}/.bash_profile && \
    echo "export PS1='\\[\\e[0;32m\\][docker]:\\u@\\h:\\w\\$ \\[\\e[0m\\]'" >> /home/${USERNAME}/.bash_profile && \
    echo "cd /home/${USERNAME}/roboracer_ws" >> /home/${USERNAME}/.bash_profile


# =============================================================================
# Switch to User Context
# =============================================================================

USER $username
ENV HOME=/home/$username
WORKDIR /home/$username

# =============================================================================
# Python Package Installation
# =============================================================================

# System pip is being used
#RUN python3 -m ensurepip --default-pip
#RUN python3 -m pip install --upgrade pip
#RUN pip install \
#  pygame
#  torch \
#  torchvision \
#  torchaudio \
#  torchinfo \
#  torchmetrics \
#  protobuf \
#  tensorboard \
#  pytest \
#  pandas jupyterlab matplotlib seaborn unzip \
#  scikit-learn \
#  tqdm

# =============================================================================
# NumPy Upgrade (separate to ensure compatibility)
# =============================================================================
#RUN pip3 install numpy --upgrade
