#!/bin/bash

#set -e
#set -x

ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
_GID=$(id -g)
_UID=$(id -u)
_UNAME=$(id -un)

USAGE="$0 [command: build|start|stop|restart|shell|cmd|rm] [--name container_name]"

# Initialize variables
DOCKER_COMMAND=""
CONTAINER_NAME=""
CMD_TO_RUN=""
HOST_FLAGS=""

# Auto-detect platform for informational purposes
ARCH=$(uname -m)
if [[ "$ARCH" == "aarch64" ]] || [[ "$ARCH" == "arm64" ]]; then
    DETECTED_PLATFORM="arm64"
elif [[ "$ARCH" == "x86_64" ]]; then
    DETECTED_PLATFORM="amd64"
else
    DETECTED_PLATFORM="unknown"
fi

# Check if we're on a Jetson
ISJETSON=0
if command -v nvpmodel &> /dev/null; then
    #echo "This is likely a NVIDIA Jetson device."
    ISJETSON=1
    HOST_FLAGS+=" --runtime nvidia --privileged --ipc=host --pid host --cap-add SYS_PTRACE "
else
    echo ''
    #echo "This does not appear to be a NVIDIA Jetson device (nvpmodel not found)."
fi

DOCKER_COMMAND=$1
if [ -z "$DOCKER_COMMAND" ]; then
  echo "Please specify a command."
  echo $USAGE
  exit
fi

# Parse arguments
shift 1  # Remove the command
while [[ $# -gt 0 ]]; do
  case $1 in
    --name|-n)
      CONTAINER_NAME="$2"
      shift 2
      ;;
    *)
      # For cmd command, remaining args are the command to execute
      if [ "$DOCKER_COMMAND" = "cmd" ]; then
        COMMAND_TO_EXEC="$*"
        break
      else
        echo "Unknown argument: $1"
        echo $USAGE
        exit 1
      fi
      ;;
  esac
done

CONTAINER_NAME_FILE=$ROOT/config/name

# If no custom name provided via command line, try to load from file
if [ -z "$CONTAINER_NAME" ]; then
  if test -f "$CONTAINER_NAME_FILE"; then
    CONTAINER_NAME="$(cat $CONTAINER_NAME_FILE)"
    # echo "Container name loaded from $CONTAINER_NAME_FILE: $CONTAINER_NAME"
  fi
fi

if [ -z "$CONTAINER_NAME" ]; then
  echo "Please specify a container name."
  echo $USAGE
  exit
fi
if [[ ! -f $CONTAINER_NAME_FILE ]]; then
  echo $CONTAINER_NAME > $CONTAINER_NAME_FILE
fi

# Read CAR_IP from config file or detect from wg0 interface on Jetson
CAR_IP_FILE=$ROOT/config/car_ip
CAR_IP=""
if [ "$ISJETSON" -eq 1 ]; then
  # On Jetson, try to get IP from wg0 interface
  if command -v ip &> /dev/null && ip addr show wg0 &> /dev/null; then
    CAR_IP=$(ip -4 addr show wg0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
    if [ -n "$CAR_IP" ]; then
      echo "CAR_IP detected from wg0 interface: $CAR_IP"
    else
      echo "Warning: wg0 interface found but no IPv4 address detected."
    fi
  else
    echo "Warning: wg0 interface not found on Jetson."
  fi
elif test -f "$CAR_IP_FILE"; then
  CAR_IP="$(cat $CAR_IP_FILE)"
  echo "CAR_IP loaded from $CAR_IP_FILE: $CAR_IP"
else
  echo "Warning: $CAR_IP_FILE not found. CAR_IP will not be set."
fi

CONTAINER_FILE=$ROOT/docker/Dockerfile
_DISPLAY="${DISPLAY-:0}"

RUNNING_CONTAINER=$(docker container ls -q --filter name=$CONTAINER_NAME)

EXEC="/bin/bash -l"
MOUNT_DATA=""
while read -r line; do
    # Skip Jetson-specific mounts if not on Jetson
    if [ "$ISJETSON" -eq 0 ]; then
        if [[ "$line" == *"tegra"* ]] || \
           [[ "$line" == *"nvhost"* ]] || \
           [[ "$line" == *"nvmap"* ]] || \
           [[ "$line" == *"argus"* ]]; then
            continue
        fi
    fi
    MOUNT_DATA="${MOUNT_DATA} $(eval echo -e "$line")"
done < "$ROOT/config/mounts"
PORT_DATA=""
while read -r line; do
    PORT_DATA="${PORT_DATA} $(eval echo -e "$line")"
done < "$ROOT/config/ports"

# host-specific setup
case "$(uname -s)" in
   Darwin)
     echo 'Mac OS X'
     _DISPLAY=":9"
     # Remove X11 socket mount for XQuartz, use TurboVNC instead
     MOUNT_DATA=${MOUNT_DATA//-v \/tmp\/.X11-unix:\/tmp\/.X11-unix/}
     ;;
   Linux)
     HOST_FLAGS+="--gpus all"
     HOST_EXEC=$EXEC
     ;;
   CYGWIN*|MINGW32*|MSYS*|MINGW*)
     echo 'MS Windows'
     ;;
   *)
     echo 'Other OS'
     ;;
esac

dockerbuild() {
  # Detect NVIDIA GPU for CUDA installation (Desktop/AMD64 only)
  INSTALL_CUDA="false"
  if [ "$DETECTED_PLATFORM" = "amd64" ]; then
    if command -v nvidia-smi &> /dev/null && nvidia-smi &> /dev/null; then
      INSTALL_CUDA="true"
      echo "NVIDIA GPU detected - CUDA will be installed"
    else
      echo "No NVIDIA GPU detected - CUDA will be skipped"
    fi
  fi
  echo "Building container $CONTAINER_NAME from $CONTAINER_FILE with args:"
  echo "  GID: $_GID"
  echo "  UID: $_UID"
  echo "  UNAME: $_UNAME"
  echo "  ROOT: $ROOT"
  echo "  PLATFORM: $DETECTED_PLATFORM"
  echo "  ISJETSON: $ISJETSON"
  echo "  INSTALL_CUDA: $INSTALL_CUDA"

  # Select base image for ARM64
  # Extract default from Dockerfile to avoid duplication
  BASE_IMAGE_ARM64=$(grep "^ARG BASE_IMAGE_ARM64=" $CONTAINER_FILE | cut -d= -f2)
  if [ -z "$BASE_IMAGE_ARM64" ]; then
      echo "Error: Could not extract BASE_IMAGE_ARM64 from $CONTAINER_FILE"
      exit 1
  fi
  if [ "$DETECTED_PLATFORM" = "arm64" ] && [ "$ISJETSON" -eq 0 ]; then
    echo "Detected non-Jetson ARM64 platform (e.g. macOS). Using Ubuntu 22.04 base image."
    BASE_IMAGE_ARM64="ubuntu:22.04"
  fi
  echo "  BASE_IMAGE_ARM64: $BASE_IMAGE_ARM64"
  
  # Convert ISJETSON to boolean string
  if [ "$ISJETSON" -eq 1 ]; then
    IS_JETSON_BOOL="true"
  else
    IS_JETSON_BOOL="false"
  fi
  echo "  IS_JETSON_BOOL: $IS_JETSON_BOOL"

  docker build \
    --network=host \
    --build-arg gid=$_GID \
    --build-arg uid=$_UID \
    --build-arg username=$_UNAME \
    --build-arg install_cuda=$INSTALL_CUDA \
    --build-arg BASE_IMAGE_ARM64=$BASE_IMAGE_ARM64 \
    --build-arg is_jetson=$IS_JETSON_BOOL \
    -t $CONTAINER_NAME \
    -f docker/Dockerfile $ROOT \
    --progress=plain
}
dockerprune() {
  docker image prune -f
}
dockerrun() {
  # Retry docker run up to 3 times to avoid race when multiple processes try to
  # create the same container name concurrently. If another process created
  # the container between attempts, consider that a success.
  local max_attempts=5
  local attempt=1
  # Prepare environment flags
  local env_flags="-e DISPLAY=$_DISPLAY"
  if [ -n "$CAR_IP" ]; then
    env_flags="$env_flags -e CAR_IP=$CAR_IP"
  fi
  while true; do
    if docker run --rm \
      $HOST_FLAGS \
      $MOUNT_DATA \
      $PORT_DATA \
      --ulimit nofile=65536:65536 \
      $env_flags \
      -it -d --name=$CONTAINER_NAME $CONTAINER_NAME $HOST_EXEC; then
      # started successfully
      RUNNING_CONTAINER=$(docker container ls -q --filter name=$CONTAINER_NAME)
      break
    else
      rc=$?
      # Check if container exists now (another parallel process started it)
      RUNNING_CONTAINER=$(docker container ls -q --filter name=$CONTAINER_NAME)
      if [[ ! -z "$RUNNING_CONTAINER" ]]; then
        echo "Container $CONTAINER_NAME is already running (detected after failed run)."
        break
      fi
      if [ $attempt -ge $max_attempts ]; then
        echo "Failed to start container $CONTAINER_NAME after $attempt attempts."
        return $rc
      fi
      echo "Attempt $attempt to start $CONTAINER_NAME failed; retrying..."
      attempt=$((attempt+1))
      sleep 5
    fi
  done
  echo "Container $CONTAINER_NAME is running with ID $RUNNING_CONTAINER"
}
dockerstop() {
  # Find any container with the name, running or stopped
  local container_id=$(docker container ls -aq --filter name="^/${CONTAINER_NAME}$")
  if [[ ! -z "$container_id" ]]; then
    echo "Stopping and removing container $CONTAINER_NAME ($container_id)..."
    docker stop $container_id >/dev/null 2>&1 || true
    docker rm $container_id >/dev/null 2>&1 || true
  else
    echo "$CONTAINER_NAME is not running or does not exist"
  fi
}
dockershell() {
  docker exec -it $RUNNING_CONTAINER $EXEC
}
dockercmd() {
  RUNNING_CONTAINER=$(docker container ls -q --filter name=$CONTAINER_NAME)
  docker exec -it $RUNNING_CONTAINER /bin/bash -l -c "$@"
}

case $DOCKER_COMMAND in
  build)
    dockerbuild
    dockerprune
    dockerstop
    dockerrun
    ;;
  prune)
    dockerprune
    ;;
  start)
    dockerrun
    ;;
  stop)
    if [[ ! -z "$RUNNING_CONTAINER" ]]; then
      docker stop $RUNNING_CONTAINER
      docker rm $RUNNING_CONTAINER
    else
      echo "$CONTAINER_NAME is not running"
      # Check if there's a stopped container with the same name and remove it
      STOPPED_CONTAINER=$(docker container ls -aq --filter name=$CONTAINER_NAME)
      if [[ ! -z "$STOPPED_CONTAINER" ]]; then
        echo "Removing stopped container $CONTAINER_NAME"
        docker rm $STOPPED_CONTAINER
      fi
    fi
    ;;
  restart)
    dockerstop
    RUNNING_CONTAINER=$(docker container ls -q --filter name=$CONTAINER_NAME)
    dockerrun
    ;;
  shell)
    [[ ! -z "$RUNNING_CONTAINER" ]] || dockerrun
    RUNNING_CONTAINER=$(docker container ls -q --filter name=$CONTAINER_NAME)
    dockershell
    ;;
  cmd)
    # Command was already parsed above
    if [ -z "$COMMAND_TO_EXEC" ]; then
      echo "Please specify a command to execute."
      echo "Usage: $0 cmd [--name container_name] 'command'"
      exit 1
    fi
    [[ ! -z "$RUNNING_CONTAINER" ]] || dockerrun
    dockercmd "$COMMAND_TO_EXEC"
    ;;
  rm)
    dockerstop
    docker rmi $CONTAINER_NAME || echo "Image $CONTAINER_NAME does not exist"
    ;;
   *)
     echo Unknown Command $DOCKER_COMMAND
     # Display usage
     echo $USAGE
     exit 1
     ;;
esac
