#!/bin/bash

#set -e
#set -x

ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
_GID=$(id -g)
_UID=$(id -u)
_UNAME=$(id -un)

USAGE="$0 [command: build|start|stop|restart|shell|run] --container-name <name> [--cmd <command>]"

# Initialize variables
DOCKER_COMMAND=""
CONTAINER_NAME=""
CMD_TO_RUN=""
HOST_FLAGS=""

# Check if we're on a Jetson
ISJETSON=0
if command -v nvpmodel &> /dev/null; then
    echo "This is likely a NVIDIA Jetson device."
    ISJETSON=1
    HOST_FLAGS+=" --runtime nvidia "
else
    echo "This does not appear to be a NVIDIA Jetson device (nvpmodel not found)."
fi

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    build|start|stop|restart|shell|run|prune|rm)
      if [ -z "$DOCKER_COMMAND" ]; then
        DOCKER_COMMAND=$1
      else
        echo "Error: Multiple commands specified"
        echo $USAGE
        exit 1
      fi
      shift
      ;;
    --container-name)
      CONTAINER_NAME="$2"
      shift 2
      ;;
    --cmd)
      CMD_TO_RUN="$2"
      shift 2
      ;;
    *)
      echo "Unknown argument: $1"
      echo $USAGE
      exit 1
      ;;
  esac
done

if [ -z "$DOCKER_COMMAND" ]; then
  echo "Please specify a command."
  echo $USAGE
  exit 1
fi

CONTAINER_NAME_FILE=$ROOT/config/name
if test -f "$CONTAINER_NAME_FILE" && [ -z "$CONTAINER_NAME" ]; then
  CONTAINER_NAME="$(cat $CONTAINER_NAME_FILE)"
  #echo "Container name loaded from $CONTAINER_NAME_FILE: $CONTAINER_NAME"
fi
if [ -z "$CONTAINER_NAME" ]; then
  echo "Please specify a container name using --container-name."
  echo $USAGE
  exit 1
fi
if [[ ! -f $CONTAINER_NAME_FILE ]]; then
  echo $CONTAINER_NAME > $CONTAINER_NAME_FILE
fi

# Validate run command requirements
if [ "$DOCKER_COMMAND" = "run" ] && [ -z "$CMD_TO_RUN" ]; then
  echo "Error: --cmd argument is required when using 'run' command"
  echo $USAGE
  exit 1
fi

# if we're on a jetson
if [ $ISJETSON -eq 1 ]; then
  CONTAINER_FILE=$ROOT/docker/Dockerfile_jetson
else
  CONTAINER_FILE=$ROOT/docker/Dockerfile
fi
_DISPLAY="${DISPLAY-:1.0}"

RUNNING_CONTAINER=$(docker container ls -q --filter name=$CONTAINER_NAME)

EXEC="/bin/bash -l"
MOUNT_DATA=""
while read -r line; do
    MOUNT_DATA="${MOUNT_DATA} $(eval echo -e "$line")"
done < "$ROOT/config/mounts"
PORT_DATA=""
while read -r line; do
    PORT_DATA="${PORT_DATA} $(eval echo -e "$line")"
done < "$ROOT/config/ports"
# host-specific setup
case "$(uname -s)" in
   Darwin)
     #echo 'Mac OS X'
     ;;
   Linux)
     #echo 'Linux'
     set +e
     xhost +local: 2>/dev/null
     set -e
     HOST_FLAGS+=" --gpus all "
     HOST_EXEC=$EXEC
     ;;
   CYGWIN*|MINGW32*|MSYS*|MINGW*)
     echo 'MS Windows'
     ;;
   *)
     echo 'Other OS'
     ;;
esac

dockerbuild() {
  docker build \
    --build-arg gid=$_GID \
    --build-arg uid=$_UID \
    --build-arg username=$_UNAME \
    -t $CONTAINER_NAME \
    -f $CONTAINER_FILE $ROOT
}
dockerprune() {
  docker image prune -f
}
dockerstart() {
  docker run --rm \
    $HOST_FLAGS \
    $MOUNT_DATA \
    $PORT_DATA \
    --ulimit nofile=65536:65536 \
    -e DISPLAY=$_DISPLAY \
    -it -d --name=$CONTAINER_NAME $CONTAINER_NAME $HOST_EXEC
}
dockerstop() {
  [[ ! -z "$RUNNING_CONTAINER" ]] && docker stop $RUNNING_CONTAINER || echo "$CONTAINER_NAME is not running"
}
dockershell() {
  docker exec -it $RUNNING_CONTAINER $EXEC
}
dockerrun() {
  docker exec -t $RUNNING_CONTAINER bash -c "$CMD_TO_RUN"
}

case $DOCKER_COMMAND in
  build)
    dockerbuild
    dockerprune
    dockerstop
    dockerstart
    ;;
  prune)
    dockerprune
    ;;
  start)
    dockerstart
    ;;
  stop)
    dockerstop
    ;;
  restart)
    dockerstop
    dockerstart
    ;;
  shell)
    [[ ! -z "$RUNNING_CONTAINER" ]] || dockerstart
    RUNNING_CONTAINER=$(docker container ls -q --filter name=$CONTAINER_NAME)
    dockershell
    ;;
  run)
    [[ ! -z "$RUNNING_CONTAINER" ]] || dockerstart
    RUNNING_CONTAINER=$(docker container ls -q --filter name=$CONTAINER_NAME)
    dockerrun
    ;;
  rm)
    dockerstop
    docker rmi $CONTAINER_NAME || echo "Image $CONTAINER_NAME does not exist"
    ;;
   *)
     echo Unknown Command $DOCKER_COMMAND
     # Display usage
     echo $USAGE
     exit 1
     ;;
esac

